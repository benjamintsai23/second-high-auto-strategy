name: äºŒæ¬¡å‰µæ–°é«˜ç­–ç•¥-æ¯æ™š21é»è‡ªå‹•æ¨æ’­

on:
  # æ¯æ™š 21:00 å°ç£æ™‚é–“ (UTC 13:00) è‡ªå‹•åŸ·è¡Œï¼Œåƒ…å·¥ä½œæ—¥
  schedule:
    - cron: '0 13 * * 1-5'  # é€±ä¸€åˆ°é€±äº” 21:00 å°ç£æ™‚é–“
    
  # æ‰‹å‹•æ¸¬è©¦è§¸ç™¼
  workflow_dispatch:
    inputs:
      force_weekend:
        description: 'å¼·åˆ¶åœ¨é€±æœ«åŸ·è¡Œ'
        required: false
        default: false
        type: boolean

env:
  TIMEZONE: 'Asia/Taipei'

jobs:
  strategy-analysis:
    name: äºŒæ¬¡å‰µæ–°é«˜ç­–ç•¥åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: æª¢æŸ¥åŸ·è¡Œæ¢ä»¶
      id: check_conditions
      run: |
        echo "=== åŸ·è¡Œæ¢ä»¶æª¢æŸ¥ ==="
        
        # å–å¾—å°ç£æ™‚é–“
        TW_TIME=$(TZ=Asia/Taipei date)
        TW_WEEKDAY=$(TZ=Asia/Taipei date +%u)  # 1=é€±ä¸€, 7=é€±æ—¥
        TW_DATE=$(TZ=Asia/Taipei date +%Y-%m-%d)
        TW_HOUR=$(TZ=Asia/Taipei date +%H)
        
        echo "ğŸ‡¹ğŸ‡¼ å°ç£æ™‚é–“: $TW_TIME"
        echo "ğŸ“… é€±å¹¾: $TW_WEEKDAY (1=é€±ä¸€, 7=é€±æ—¥)"
        echo "ğŸ•˜ æ™‚é–“: $TW_HOUR é»"
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºå·¥ä½œæ—¥
        if [ "$TW_WEEKDAY" -ge "6" ]; then
          echo "âš ï¸ ä»Šæ—¥ç‚ºé€±æœ«"
          if [ "${{ github.event.inputs.force_weekend }}" == "true" ]; then
            echo "ğŸ”§ å¼·åˆ¶åŸ·è¡Œæ¨¡å¼å•Ÿç”¨"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ é€±æœ«ä¸åŸ·è¡Œï¼Œç¨‹åºçµæŸ"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âœ… å·¥ä½œæ—¥ï¼Œç¬¦åˆåŸ·è¡Œæ¢ä»¶"
          echo "should_run=true" >> $GITHUB_OUTPUT
        fi
        
        # è¼¸å‡ºç’°å¢ƒè³‡è¨Š
        echo ""
        echo "=== ç’°å¢ƒè³‡è¨Š ==="
        echo "ğŸ¤– è§¸ç™¼æ–¹å¼: ${{ github.event_name }}"
        echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
        echo "ğŸ‘¤ åŸ·è¡Œè€…: ${{ github.actor }}"
        echo "ğŸ†” åŸ·è¡Œ ID: ${{ github.run_id }}"
        
    - name: æª¢æŸ¥æª”æ¡ˆçµæ§‹
      if: steps.check_conditions.outputs.should_run == 'true'
      run: |
        echo "ğŸ“ æª¢æŸ¥æª”æ¡ˆçµæ§‹..."
        echo "ç•¶å‰å·¥ä½œç›®éŒ„: $(pwd)"
        echo "æª”æ¡ˆåˆ—è¡¨:"
        ls -la
        echo ""
        echo "Python æª”æ¡ˆ:"
        find . -name "*.py" -type f
        
    - name: å®‰è£ Python ä¾è³´
      if: steps.check_conditions.outputs.should_run == 'true'
      run: |
        echo "ğŸ“¦ å®‰è£å¿…è¦å¥—ä»¶..."
        python -m pip install --upgrade pip
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ requirements.txt
        if [ -f "requirements.txt" ]; then
          echo "ä½¿ç”¨ requirements.txt å®‰è£å¥—ä»¶..."
          pip install -r requirements.txt
        else
          echo "ç›´æ¥å®‰è£å¿…è¦å¥—ä»¶..."
          pip install pandas numpy finlab python-telegram-bot python-dotenv pydantic requests pytz python-dateutil
        fi
        echo "âœ… å¥—ä»¶å®‰è£å®Œæˆ"
        
    - name: é©—è­‰ API é€£æ¥
      if: steps.check_conditions.outputs.should_run == 'true'
      env:
        FINLAB_API_TOKEN: ${{ secrets.FINLAB_API_TOKEN }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ğŸ” é©—è­‰ API é€£æ¥ç‹€æ…‹..."
        
        python << 'EOF'
        import os
        import sys
        
        print("1ï¸âƒ£ æª¢æŸ¥ç’°å¢ƒè®Šæ•¸...")
        
        # æª¢æŸ¥ FinLab Token
        finlab_token = os.getenv('FINLAB_API_TOKEN')
        if not finlab_token:
            print('âŒ FINLAB_API_TOKEN æœªè¨­å®š')
            sys.exit(1)
        print(f'âœ… FinLab Token: {len(finlab_token)} å­—å…ƒ')
        
        # æª¢æŸ¥ Telegram è¨­å®š
        tg_token = os.getenv('TELEGRAM_BOT_TOKEN')
        tg_chat_id = os.getenv('TELEGRAM_CHAT_ID')
        if not tg_token or not tg_chat_id:
            print('âŒ Telegram è¨­å®šä¸å®Œæ•´')
            sys.exit(1)
        print(f'âœ… Telegram Token: {len(tg_token)} å­—å…ƒ')
        print(f'âœ… Chat ID: {tg_chat_id}')
        
        print("\n2ï¸âƒ£ æ¸¬è©¦ FinLab é€£æ¥...")
        try:
            import finlab
            finlab.login(finlab_token)
            print('âœ… FinLab ç™»å…¥æˆåŠŸ')
            
            # æ¸¬è©¦è³‡æ–™å–å¾—
            from finlab import data
            close_data = data.get('price:æ”¶ç›¤åƒ¹')
            if close_data is not None and not close_data.empty:
                print(f'âœ… åƒ¹æ ¼è³‡æ–™: {close_data.shape[1]} æª”è‚¡ç¥¨')
                print(f'ğŸ“… æœ€æ–°æ—¥æœŸ: {close_data.index[-1]}')
            else:
                print('âŒ ç„¡æ³•å–å¾—åƒ¹æ ¼è³‡æ–™')
                sys.exit(1)
                
        except Exception as e:
            print(f'âŒ FinLab é€£æ¥å¤±æ•—: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
            
        print("\n3ï¸âƒ£ æ¸¬è©¦ Telegram é€£æ¥...")
        import requests
        try:
            url = f"https://api.telegram.org/bot{tg_token}/getMe"
            response = requests.get(url, timeout=10)
            if response.status_code == 200:
                bot_info = response.json()
                print(f"âœ… Telegram Bot: {bot_info['result']['first_name']}")
                print(f"   ç”¨æˆ¶å: @{bot_info['result']['username']}")
            else:
                print(f"âŒ Telegram API éŒ¯èª¤: {response.status_code}")
                sys.exit(1)
        except Exception as e:
            print(f"âŒ Telegram é€£æ¥å¤±æ•—: {e}")
            sys.exit(1)
        
        print("\nâœ… æ‰€æœ‰ API é€£æ¥æ­£å¸¸ï¼Œæº–å‚™åŸ·è¡Œç­–ç•¥åˆ†æ")
        EOF
        
    - name: åŸ·è¡Œç­–ç•¥åˆ†æ
      if: steps.check_conditions.outputs.should_run == 'true'
      env:
        FINLAB_API_TOKEN: ${{ secrets.FINLAB_API_TOKEN }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_ACTOR: ${{ github.actor }}
        EXECUTION_MODE: "auto_schedule"
      run: |
        echo "ğŸš€ é–‹å§‹åŸ·è¡ŒäºŒæ¬¡å‰µæ–°é«˜ç­–ç•¥åˆ†æ..."
        echo "â° åŸ·è¡Œæ™‚é–“: $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“Š åŸ·è¡Œæ¨¡å¼: è‡ªå‹•æ’ç¨‹"
        
        # å»ºç«‹æ—¥èªŒç›®éŒ„
        mkdir -p logs
        
        # è‡ªå‹•æ‰¾åˆ° Python ä¸»ç¨‹å¼æª”æ¡ˆ
        PYTHON_FILE=""
        
        # æŒ‰ç…§å„ªå…ˆé †åºå°‹æ‰¾ Python æª”æ¡ˆ
        if [ -f "strategy_bot_v2.py" ]; then
          PYTHON_FILE="strategy_bot_v2.py"
        elif [ -f "main.py" ]; then
          PYTHON_FILE="main.py"
        elif [ -f "bot.py" ]; then
          PYTHON_FILE="bot.py"
        else
          # æ‰¾ç¬¬ä¸€å€‹ Python æª”æ¡ˆ
          PYTHON_FILE=$(find . -maxdepth 1 -name "*.py" -type f | head -1)
        fi
        
        if [ -z "$PYTHON_FILE" ]; then
          echo "âŒ æ‰¾ä¸åˆ° Python ä¸»ç¨‹å¼æª”æ¡ˆ"
          echo "ğŸ“ ç•¶å‰ç›®éŒ„æª”æ¡ˆï¼š"
          ls -la
          exit 1
        fi
        
        echo "ğŸ“ ä½¿ç”¨ Python æª”æ¡ˆ: $PYTHON_FILE"
        
        # åŸ·è¡Œä¸»ç¨‹å¼ï¼ˆå¸¶é‡è©¦æ©Ÿåˆ¶ï¼‰
        MAX_RETRIES=3
        RETRY_COUNT=0
        SUCCESS=false
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = false ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "=== åŸ·è¡Œå˜—è©¦ $RETRY_COUNT/$MAX_RETRIES ==="
          
          if python "$PYTHON_FILE" 2>&1 | tee logs/execution_$RETRY_COUNT.log; then
            echo "âœ… ç­–ç•¥åŸ·è¡ŒæˆåŠŸ"
            SUCCESS=true
          else
            EXIT_CODE=$?
            echo "âŒ åŸ·è¡Œå¤±æ•—ï¼Œé€€å‡ºç¢¼: $EXIT_CODE"
            
            # é¡¯ç¤ºéŒ¯èª¤æ—¥èªŒçš„æœ€å¾Œå¹¾è¡Œ
            echo "æœ€å¾Œçš„éŒ¯èª¤è¨Šæ¯ï¼š"
            tail -10 logs/execution_$RETRY_COUNT.log
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              DELAY=$((RETRY_COUNT * 15))
              echo "â³ ${DELAY}ç§’å¾Œé‡è©¦..."
              sleep $DELAY
            fi
          fi
        done
        
        if [ "$SUCCESS" = false ]; then
          echo "ğŸ’¥ é‡è©¦æ¬¡æ•¸å·²é”ä¸Šé™ï¼ŒåŸ·è¡Œæœ€çµ‚å¤±æ•—"
          
          # ç™¼é€å¤±æ•—é€šçŸ¥åˆ° Telegram
          python << 'NOTIFY_EOF'
        import os
        import requests
        from datetime import datetime
        
        token = os.getenv('TELEGRAM_BOT_TOKEN')
        chat_id = os.getenv('TELEGRAM_CHAT_ID')
        
        if token and chat_id:
            message = f"""âŒ ç­–ç•¥æ©Ÿå™¨äººåŸ·è¡Œå¤±æ•—
        
        â° å¤±æ•—æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
        ğŸ”§ åŸ·è¡Œæ¨¡å¼: è‡ªå‹•æ’ç¨‹
        ğŸ“Š é‡è©¦æ¬¡æ•¸: 3æ¬¡å…¨éƒ¨å¤±æ•—
        
        ğŸ”— æŸ¥çœ‹è©³æƒ…: https://github.com/{os.getenv('GITHUB_REPOSITORY')}/actions/runs/{os.getenv('GITHUB_RUN_ID')}
        
        è«‹æª¢æŸ¥ï¼š
        â€¢ FinLab API Token æ˜¯å¦æœ‰æ•ˆ
        â€¢ ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸
        â€¢ ç¨‹å¼ç¢¼æ˜¯å¦æœ‰éŒ¯èª¤
        """
            
            try:
                url = f"https://api.telegram.org/bot{token}/sendMessage"
                data = {"chat_id": chat_id, "text": message}
                requests.post(url, data=data, timeout=10)
                print("âœ… å¤±æ•—é€šçŸ¥å·²ç™¼é€åˆ° Telegram")
            except Exception as e:
                print(f"âŒ ç„¡æ³•ç™¼é€å¤±æ•—é€šçŸ¥: {e}")
        NOTIFY_EOF
        
          exit 1
        fi
        
        echo "ğŸ‰ ç­–ç•¥åˆ†æå®Œæˆ"
        
    - name: ä¸Šå‚³åŸ·è¡Œè¨˜éŒ„
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: execution-logs-${{ github.run_id }}
        path: logs/
        retention-days: 7
        if-no-files-found: ignore
        
    - name: é€±æœ«è·³éé€šçŸ¥
      if: steps.check_conditions.outputs.should_run == 'false'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ğŸ—“ï¸ ä»Šæ—¥ç‚ºé€±æœ«ï¼Œç­–ç•¥åˆ†æå·²è·³é"
        echo "ğŸ“… ä¸‹æ¬¡åŸ·è¡Œ: ä¸‹é€±ä¸€æ™šä¸Š 21:00"
        
        # ç™¼é€é€±æœ«è·³éé€šçŸ¥åˆ° Telegram
        python << 'WEEKEND_EOF'
        import os
        import requests
        from datetime import datetime
        
        token = os.getenv('TELEGRAM_BOT_TOKEN')
        chat_id = os.getenv('TELEGRAM_CHAT_ID')
        
        if token and chat_id:
            message = f"""ğŸ—“ï¸ é€±æœ«ä¼‘å¸‚é€šçŸ¥
        
        ğŸ“… {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')} ç‚ºé€±æœ«
        
        ğŸ’¡ ç­–ç•¥æ©Ÿå™¨äººè‡ªå‹•è·³éåŸ·è¡Œ
        â° ä¸‹æ¬¡åŸ·è¡Œï¼šé€±ä¸€æ™šä¸Š 21:00
        
        ğŸ“ˆ åˆ©ç”¨é€±æœ«æ™‚é–“ï¼š
        â€¢ æª¢è¦–æœ¬é€±æ“ä½œç¸¾æ•ˆ
        â€¢ é—œæ³¨åœ‹éš›å¸‚å ´å‹•æ…‹
        â€¢ æº–å‚™ä¸‹é€±æŠ•è³‡ç­–ç•¥
        
        ç¥æ‚¨é€±æœ«æ„‰å¿«ï¼ ğŸŒŸ
        """
            
            try:
                url = f"https://api.telegram.org/bot{token}/sendMessage"
                data = {"chat_id": chat_id, "text": message}
                requests.post(url, data=data, timeout=10)
                print("âœ… é€±æœ«é€šçŸ¥å·²ç™¼é€åˆ° Telegram")
            except Exception as e:
                print(f"âŒ ç„¡æ³•ç™¼é€é€±æœ«é€šçŸ¥: {e}")
        WEEKEND_EOF
